<template>
    <div>
        <div id="title-bar">
            <a id="back-button" href="#" @click="back(false)">
                <span class="glyphicon glyphicon-chevron-left"></span>
            </a>
            <div class="created-time-wrapper animation-intro">
                <p>
                    created {{ moment(forum.createDateTime) }} &nbsp;
                    <b>
                        <i>by</i>
                    </b>
                    &nbsp;
                    <img class="owner-image img-circle" :src="forum.owner.thumnail" v-if="forum.owner!=null">
                    <b>{{ forum.owner==null ? "Unknown" : forum.owner.name }}</b>
                </p>
            </div>
            <hr>
        </div>

        <div class="content animation-intro">
            <!-- forum header -->
            <div id="forum-header">
                <h4>
                    <b>Title: </b>{{ forum.title }}
                </h4>
                <p class="lead" v-html="preProcessText(forum.desc)"></p>

                <div class="container" v-if="(forum.owner!=null && forum.owner._id==user._id) || user.roleIndex==0">
                    <div class="row">
                        <div class="btn-group pull-right">
                            <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#edit-forum-modal" @click="editForum_Click">Edit</button>
                            <button class="btn btn-sm btn-danger" data-toggle="modal" data-target="#delete-forum-modal">Remove</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="forum-comments">
                <h4 class="text-center">
                    <span class="glyphicon glyphicon-comment"></span>&nbsp;&nbsp;Comments
                </h4>
                <hr>

                <div v-if="comments.length!=0">
                    <div class="animation-intro" v-for="c in comments" :key="c._id">
                        <div class="well">
                            <p>
                                <img class="comment-user-image img-circle" :src="c.user.thumnail" v-if="c.user!=null">
                                <b>{{ c.user==null ? "Unknown" : c.user.name }}</b>
                            </p>
                            <p v-html="preProcessText(c.content)"></p>

                            <p class="text-right">commented {{moment(c.createDateTime)}}</p>
                        </div>
                    </div>
                </div>

                <!-- empty message -->
                <div class="text-center" v-else>
                    <h4 class="lead">- No Comments -</h4>
                </div>
            </div>
        </div>

        <button id="comment-button" class="btn btn-warning" data-toggle="modal" data-target="#add-comment-modal">Add Comment</button>

        <!-- add comment dialog -->
        <div id="add-comment-modal" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button class="close" aria-hidden="true" type="button" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">
                            <span class="glyphicon glyphicon-th-list"></span>&nbsp;&nbsp;Add Comment
                        </h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-horizontal">
                            <!-- comment -->
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <textarea class="form-control" id="forum-desc-input" rows="3" v-model="commentInput"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-default" type="button" data-dismiss="modal">Cancel</button>
                        <button class="btn btn-success" type="button" data-dismiss="modal" :disabled="commentInput.trim().length==0" @click="addComment_Click">Add</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- edit forum dialog -->
        <div id="edit-forum-modal" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button class="close" aria-hidden="true" type="button" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">
                            <span class="glyphicon glyphicon-th-list"></span>&nbsp;&nbsp;Edit Post
                        </h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-horizontal">
                            <!-- title -->
                            <div class="form-group">
                                <label class="col-sm-2 control-label" for="forum-title-input">
                                    <b>Title</b>
                                </label>
                                <div class="col-sm-10">
                                    <input class="form-control" id="forum-title-input" type="text" v-model="forumTitleInput">
                                </div>
                            </div>

                            <!-- desc -->
                            <div class="form-group">
                                <label class="col-sm-2 control-label" for="forum-desc-input">
                                    <b>Description</b>
                                </label>
                                <div class="col-sm-10">
                                    <textarea class="form-control" id="forum-desc-input" rows="3" v-model="forumDescInput"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-default" type="button" data-dismiss="modal">Cancel</button>
                        <button class="btn btn-success" type="button" data-dismiss="modal" :disabled="forumTitleInput.trim().length==0 || forumDescInput.trim().length==0" @click="editForumDialog_Click">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- delete modal -->
        <div id="delete-forum-modal" class="modal fade" v-if="(forum.owner!=null && forum.owner._id==user._id) || user.roleIndex==0">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button class="close" aria-hidden="true" type="button" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">
                            <span class="glyphicon glyphicon-trash"></span>&nbsp;&nbsp;Delete post
                        </h4>
                    </div>
                    <div class="modal-body">
                        <p>Are you to remove the post?</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-default" type="button" data-dismiss="modal">No</button>
                        <button class="btn btn-danger" type="button" data-dismiss="modal" @click="removeForum_Click">Yes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    const moment = require("moment");

    export default {
      data() {
        return {
          comments: "",
          commentInput: "",
          forumTitleInput: "",
          forumDescInput: "",
          bakForum: {
            title: "",
            desc: ""
          }
        };
      },
      methods: {
        moment(date) {
          return moment(date).fromNow();
        },
        preProcessText(text) {
          const exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;
          return text
            .replace(exp, "<a target='_blank' href='$1'>$1</a>")
            .replace(/\n\r?/g, "<br />");
        },
        back(needRefresh) {
          this.$store.commit("changeCurrentSelectedForum", {}); //clear selection
          this.$store.commit("switchView", {
            view: this.CourseView,
            needRefresh: needRefresh
          });
        },
        editForum_Click() {
          this.forumTitleInput = this.bakForum.title = this.forum.title;
          this.forumDescInput = this.bakForum.title = this.forum.desc;
        },
        editForumDialog_Click() {
          this.$http
            .put("/forum/update", {
              id: this.forum._id,
              title: this.forumTitleInput,
              desc: this.forumDescInput
            })
            .then(data => {
              return data.status;
            })
            .then(status => {
              if (status == 200) {
                this.forum.title = this.forumTitleInput;
                this.forum.desc = this.forumDescInput;
                alert("Post updated");
              } else {
                this.forum.title = this.bakForum.title;
                this.forum.desc = this.bakForum.title;
                alert("error");
              }
            });
        },
        removeForum_Click() {
          this.$http
            .delete(`/forum/remove/${this.forum._id}`)
            .then(data => {
              return data.status;
            })
            .then(status => {
              if (status == 200) {
                this.back(true);
                alert("Post removed");
              } else {
                alert("Error");
              }
            });
        },
        addComment_Click() {
          this.$http
            .post("/forum/comment/add", {
              forumId: this.forum._id,
              content: this.commentInput
            })
            .then(data => {
              return data.status;
            })
            .then(status => {
              if (status == 200) {
                this.refreshComments();
              } else {
                alert("Error");
              }
            });
        },
        refreshComments() {
          this.$http
            .get(`/forum/comment/all/${this.forum._id}`)
            .then(data => {
              return data.json();
            })
            .then(data => {
              this.comments = data;
            });
        }
      },
      computed: {
        forum() {
          return this.$store.state.currentSelectedForum;
        },
        CourseView() {
          return this.$store.state.Course;
        },
        user() {
          return this.$store.state.user;
        }
      },
      created() {
        this.refreshComments();
      }
    };
</script>

<style scoped>
    @keyframes intro {
      from {
        opacity: 0;
        zoom: 0;
      }
      to {
        opacity: 1;
        zoom: 1;
      }
    }

    .animation-intro {
      animation-name: intro;
      animation-duration: 0.5s;
    }

    a#back-button {
      text-decoration: none;
      padding: 0 8px;
    }

    #title-bar {
      padding-top: 16px;
      background-color: white;
      /* position: -webkit-sticky;                                                                                                                                    position: sticky; */
      position: fixed;
      top: 64px;
      right: 10%;
      left: 10%;
      z-index: 10;
    }

    @media screen and (max-width: 1500px) {
      #title-bar {
        top: 64px;
        right: 2%;
        left: 2%;
      }
    }

    #title-bar span,
    #title-bar p {
      font-size: 20px;
      display: inline;
    }

    #title-bar hr {
      border-top-width: 2px;
      margin-bottom: 0;
    }

    #title-bar .owner-image {
      max-width: 30px;
    }

    .content {
      margin-top: 80px;
    }

    .created-time-wrapper {
      float: right;
    }

    .created-time-wrapper p {
      font-size: 13px !important;
    }

    .created-time-wrapper::after {
      content: "";
      display: block;
      clear: both;
    }

    #forum-header {
      margin-bottom: 50px;
    }

    #forum-header p {
      word-wrap: break-word;
      font-size: 20px;
    }

    #forum-comments hr {
      border-top-width: 2px;
      width: 30%;
    }

    .comment-user-image {
      max-width: 30px;
    }

    #comment-button {
      position: fixed;
      right: 30px;
      bottom: 30px;
    }
</style>
